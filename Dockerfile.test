FROM vaultwarden/server:latest

# Set environment variables
ENV ROCKET_PROFILE="release" \
    ROCKET_ADDRESS=0.0.0.0 \
    ROCKET_PORT=8080 \
    WEBSOCKET_ADDRESS=0.0.0.0 \
    WEBSOCKET_PORT=3012 \
    SSL_CERT_DIR=/etc/ssl/certs \
    EMERGENCY_ACCESS_ALLOWED=true \
    EXTENDED_LOGGING=false \
    ICON_SERVICE=google \
    IP_HEADER=X-Forwarded-For \
    LOG_LEVEL=Info \
    ORG_CREATION_USERS=all \
    ORG_EVENTS_ENABLED=false \
    ORG_GROUPS_ENABLED=false \
    PUSH_ENABLED=false \
    RELOAD_TEMPLATES=false \
    ROCKET_WORKERS=100 \
    SENDS_ALLOWED=true \
    SHOW_PASSWORD_HINT=false \
    SIGNUPS_ALLOWED=true \
    SIGNUPS_VERIFY=false \
    USE_SYSLOG=false \
    WEBSOCKET_ENABLED=true \
    WEB_VAULT_ENABLED=true \
    DOMAIN=https://north.martinatortime.us.to \
    DOMAIN_NAME=north.martinatortime.us.to

VOLUME /data
EXPOSE 80
EXPOSE 3012

# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y sqlite3 libpq5 git wget curl tar lsof jq gpg ca-certificates openssl tmux && \
    rm -rf /var/lib/apt/lists/*


# Get the latest release URLs for Caddy, SuperCronic, Overmind, and Web-Vault
RUN caddyReleaseURL=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | jq -r '.assets[] | select(.name | test("caddy_.*_linux_amd64.tar.gz")) | .browser_download_url') && \
    supercronicReleaseURL=$(curl -s https://api.github.com/repos/aptible/supercronic/releases/latest | jq -r '.assets[] | select(.name | test("supercronic-linux-amd64")) | .browser_download_url') && \
    overmindReleaseURL=$(curl -s https://api.github.com/repos/DarthSim/overmind/releases/latest | jq -r '.assets[] | select(.name | test("overmind-v.*-linux-amd64")) | .browser_download_url') && \
    vaultReleaseURL=$(curl -s https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest | jq -r '.assets[] | select(.name | test("bw_web_v.*.tar.gz")) | .browser_download_url')

# Remove the existing folders if they exist
RUN rm -rf /web-vault /usr/local/bin/caddy /usr/local/bin/overmind /usr/local/bin/supercronic

# Download and extract the latest releases
RUN curl -L -o "/web-vault.tar.gz" "$vaultReleaseURL" && \
    tar -xzf "/web-vault.tar.gz" -C / && \
    curl -L -o "/caddy.tar.gz" "$caddyReleaseURL" && \
    tar -xzf "/caddy.tar.gz" -C /usr/local/bin/ caddy && \
    curl -L -o "/overmind.gz" "$overmindReleaseURL" && \
    gunzip "/overmind.gz" && \
    chmod +x "/overmind" && \
    mv "/overmind" /usr/local/bin/ && \
    curl -L -o "/supercronic" "$supercronicReleaseURL" && \
    chmod +x "/supercronic" && \
    mv "/supercronic" /usr/local/bin/

# Clean up downloaded archive files
RUN rm "/web-vault.tar.gz" "/caddy.tar.gz"

# Copy other files
COPY config/crontab .
COPY config/Procfile .
COPY config/Caddyfile /etc/caddy/Caddyfile

COPY scripts/restore.sh /restore.sh
COPY scripts/backup-data-north.sh /backup-data.sh

# Chmod the scripts
RUN chmod +x /restore.sh
RUN chmod +x /backup-data.sh

# Start Vaultwarden
CMD ["overmind", "start"]
